# Estimate Rollup

## Background
This analysis is designed to combine/rollup two or more independently produced estimates of abundance. Depending on the format of the data/estimate inputs, the script can also generate combined estimates of the proportion hatchery-origin spawners (pHOS) and proportional abundance by age (pAge).

The analysis was specifically built to generate an annual rollup, population-level estimate for Lewis Basin tule fall Chinook by origin (hatchery, wild).  However, the analysis is agnostic to the specific populations/groupings and uses estimates of abundance (mean & standard deviation) as input data and combines the desired "sub-population" estimates using log-normal moment matching (see pg. 65-68 & Table A.2 in Hobbs and Hooten 2015).

For Lewis Basin tule fall Chinook, which can used as an example for other populations/datasets, the script uses a standardized data input file to combine estimates of abundance that have been generated by SpawningYear, Param (i.e., origin; NOSAEJ, HOSAEJ, and TSAEJ), and Waterbody (East Fork Lewis River, North Fork Lewis River, and Cedar Creek). Because the script uses SpawningYear as a summary file, the data file can be added to each year. If desired, the analysis can generate combined estimates for multiple populations using the column header "CommonPopName" population/grouping.

## How to Use
1. open the .csv data/estimates file where located and update with estimates of abundance, as needed, following the example/existing data strucutre.  Data files can be stored in two locations:
    - Locally (individual computer): data file should be stored within a folder named "" within the "Estimate_rollup" project folder
    - Teams: if stored on Teams, you'll need to sync the Teams folder and map to T:/ network drive following the instructions outlined below
2. Open the "Estimate_rollup.Rproj" file (which will launch the analysis Project in RStudio)
3. Open the desired analysis .R file located in the project_scripts folder (e.g., "Lewis_Rollup_Chinook_Tule_abundance_pHOS_pAge_2022-2023.R")
4. Update user defined information:
    - if needed, update the location and file name of input data
    - check the options listed for objects "summary_cols", "filter_age", and "add_param" that are used as arguments in the function "generate_rollup_estimates", and update as needed
5. Run the analysis script through the "Generate rollup/combined estimates of abundance using log-normal moment matching" section
6. If desired, format the combined estimate object to match SPi formatting and generate an Excel file of the formatted dataset
    - first, update the data columns that will be added to the output
    - as needed, update the output location (local vs. Teams), file path, and name of output folder and file name
    - run remaining script to the end

## Useful Information
- Make sure the data file is completely filled out for a given year before running a "final" rollup estimate. 
    - If there are any missing/empty values in the "mean" and "sd" data fields for a given year, the moment matching approach will generate NAs for the roll-up estimate.  
- Sync Teams folder
    - For the desired Teams folder (e.g., DFW-Team FP Lewis River M&E - General), navigate to the General channel in the team, click on “Files” tab at the top, and then click “Sync” link in the top/middle.  This will take a few minutes.  
    - If completed successfully, the Teams folder will show up in a File Explorer folder under the heading "Washington State Executive Branch Agencies".
- Map to T: network drive
    - Open a new File Explorer window/folder
    - Navigate to "This PC" folder 
    - At the top, select the "Computer" tab (in between the tab for "File" and "View")
    - Select "Map network drive" button option and a new window will appear
    - In the prompt, choose the letter T, and in the "Folder" box enter \\localhost\C$\Users\youruser\Washington State Executive Branch Agencies.  NOTE: be sure to change the youruser portion with your actual profile name (e.g., bentlktb)
    - Select "Finish". To confirm that the T: network drive was mapped successfully, open Rstudio or a terminal window and typing "T:/" then hit tab - you should get a little popup of the available synced directories from Teams.

## Citation
Hobbs, N.T., and M.B. Hooten. 2015. Bayesian Models: a statistical primer for ecologists. Princeton University Press. 

 
